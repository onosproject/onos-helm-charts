#!/bin/bash

if [ "$#" -lt "1" ]; then
    echo "must specify chart directory"
    exit 1
fi

set -x

chart=$1

rm -r build/release

branch=$(git branch --show-current)

# Package the Helm chart
helm package $chart --destination build/release

# Upload the Helm chart release
cr upload \
    --git-base-url https://api.github.com/ \
    --git-upload-url https://uploads.github.com/ \
    --owner onosproject \
    --git-repo onos-helm-charts \
    --package-path build/release

# Update the repository index
cr index \
    --index-path build/release/index.yaml \
    --git-base-url https://api.github.com/ \
    --git-upload-url https://uploads.github.com/ \
    --owner onosproject \
    --git-repo onos-helm-charts \
    --charts-repo https://onosproject.github.io/onos-helm-charts \
    --package-path build/release

# Branch off the gh-pages branch and commit the updated index.yaml to a development branch
git checkout gh-pages
git checkout -b release-$chart
mv build/release/index.yaml index.yaml
git add index.yaml
git commit -a -m "Add $chart release to index.yaml"
git push origin release-$chart

git checkout $branch
